{% extends 'documents/base.html' %}
{% load document_filters %}

{% block title %}{{ document.title }} - Data Structure{% endblock %}

{% block breadcrumb %}
<div class="container mt-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'documents:dashboard' %}">Tableau de bord</a></li>
            <li class="breadcrumb-item"><a href="{% url 'documents:document_list' %}">Documents</a></li>
            <li class="breadcrumb-item active">{{ document.title|truncatechars:50 }}</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h1 class="h2">{{ document.title }}</h1>
                <p class="text-muted">{{ document.description|default:"Aucune description" }}</p>
            </div>
            <div class="text-end">
                {% status_badge document.status %}
                <br>
                <small class="text-muted">
                    Téléversé le {{ document.created_at|date:"d/m/Y à H:i" }}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Informations du document -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Informations du document
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Nom du fichier :</strong></td>
                                <td>{{ document.filename }}</td>
                            </tr>
                            <tr>
                                <td><strong>Type :</strong></td>
                                <td>
                                    <i class="{{ document.file_type|file_icon }} me-1"></i>
                                    {{ document.get_file_type_display }}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Taille :</strong></td>
                                <td>{{ document.file_size|format_file_size }}</td>
                            </tr>
                            <tr>
                                <td><strong>Téléversé par :</strong></td>
                                <td>
                                    {% user_avatar document.uploaded_by 24 %}
                                    <span class="ms-2">{{ document.uploaded_by.get_full_name|default:document.uploaded_by.username }}</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Créé le :</strong></td>
                                <td>{{ document.created_at|date:"d/m/Y H:i" }}</td>
                            </tr>
                            <tr>
                                <td><strong>Modifié le :</strong></td>
                                <td>{{ document.updated_at|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% if document.annotated_by %}
                            <tr>
                                <td><strong>Annoté par :</strong></td>
                                <td>
                                    {% user_avatar document.annotated_by 24 %}
                                    <span class="ms-2">{{ document.annotated_by.get_full_name|default:document.annotated_by.username }}</span>
                                </td>
                            </tr>
                            {% endif %}
                            {% if document.validated_by %}
                            <tr>
                                <td><strong>Validé par :</strong></td>
                                <td>
                                    {% user_avatar document.validated_by 24 %}
                                    <span class="ms-2">{{ document.validated_by.get_full_name|default:document.validated_by.username }}</span>
                                </td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions rapides -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if can_edit_schema %}
                        <a href="{% url 'documents:edit_schema' document.pk %}" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-1"></i>Éditer le schéma
                        </a>
                        <button class="btn btn-outline-secondary" onclick="regenerateSchema()">
                            <i class="fas fa-sync me-1"></i>Régénérer le schéma
                        </button>
                    {% endif %}
                    
                    {% if can_annotate %}
                        <a href="{% url 'documents:annotate_document' document.pk %}" class="btn btn-outline-success">
                            <i class="fas fa-edit me-1"></i>Annoter le document
                        </a>
                        {% if annotation %}
                            <button class="btn btn-outline-secondary" onclick="regenerateAnnotations()">
                                <i class="fas fa-sync me-1"></i>Régénérer les annotations
                            </button>
                        {% endif %}
                    {% endif %}
                    
                    {% if can_validate %}
                        <a href="{% url 'documents:validate_annotation' document.pk %}" class="btn btn-outline-warning">
                            <i class="fas fa-check me-1"></i>Valider l'annotation
                        </a>
                    {% endif %}
                    
                    {% if annotation %}
                        <a href="{% url 'documents:export_annotations' document.pk %}" class="btn btn-outline-info">
                            <i class="fas fa-download me-1"></i>Exporter (JSON)
                        </a>
                        <a href="{% url 'documents:annotation_history' document.pk %}" class="btn btn-outline-secondary">
                            <i class="fas fa-history me-1"></i>Historique
                        </a>
                    {% endif %}
                    
                    <a href="{{ document.file.url }}" target="_blank" class="btn btn-outline-dark">
                        <i class="fas fa-external-link-alt me-1"></i>Voir le fichier
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Métadonnées extraites -->
{% if document.metadata %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-database me-2"></i>Métadonnées extraites
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for key, value in document.metadata.items %}
                        {% if key != 'text_preview' %}
                            <div class="col-md-6 mb-2">
                                <div class="metadata-item">
                                    <div class="metadata-key">{{ key|title|truncatechars:30 }} :</div>
                                    <div class="metadata-value">
                                        {% if value|length > 100 %}
                                            {{ value|smart_truncate:100 }}
                                        {% else %}
                                            {{ value|default:"N/A" }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                
                {% if document.metadata.text_preview %}
                    <hr>
                    <h6>Aperçu du contenu :</h6>
                    <div class="bg-light p-3 rounded">
                        <pre class="mb-0" style="white-space: pre-wrap; font-size: 0.9em;">{{ document.metadata.text_preview|smart_truncate:500 }}</pre>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Schéma d'annotation -->
{% if annotation_schema %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sitemap me-2"></i>Schéma d'annotation
                </h5>
                <div>
                    {% if annotation_schema.is_validated %}
                        <span class="badge bg-success">Validé</span>
                    {% else %}
                        <span class="badge bg-warning">En attente</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <h6>{{ annotation_schema.name }}</h6>
                <p class="text-muted">{{ annotation_schema.description }}</p>
                
                {% if annotation_schema.fields.all %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Champ</th>
                                    <th>Type</th>
                                    <th>Obligatoire</th>
                                    <th>Description</th>
                                    <th>Choix</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for field in annotation_schema.fields.all %}
                                    <tr>
                                        <td>
                                            <strong>{{ field.label }}</strong>
                                            <br>
                                            <small class="text-muted">{{ field.name }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">
                                                <i class="{{ field.field_type|field_type_icon }} me-1"></i>
                                                {{ field.get_field_type_display }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            {% if field.is_required %}
                                                <i class="fas fa-check text-success"></i>
                                            {% else %}
                                                <i class="fas fa-times text-muted"></i>
                                            {% endif %}
                                        </td>
                                        <td>{{ field.description|default:"—"|smart_truncate:50 }}</td>
                                        <td>
                                            {% if field.choices %}
                                                {% for choice in field.choices|slice:":3" %}
                                                    <span class="badge bg-secondary me-1">{{ choice }}</span>
                                                {% endfor %}
                                                {% if field.choices|length > 3 %}
                                                    <span class="text-muted small">+{{ field.choices|length|add:"-3" }} autres</span>
                                                {% endif %}
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Annotations -->
{% if annotation %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tags me-2"></i>Annotations
                </h5>
                <div>
                    <span class="badge bg-primary me-2">{{ annotation.completion_percentage|floatformat:0 }}% complété</span>
                    {% if annotation.is_validated %}
                        <span class="badge bg-success">Validé</span>
                    {% elif annotation.is_complete %}
                        <span class="badge bg-warning">En attente de validation</span>
                    {% else %}
                        <span class="badge bg-secondary">En cours</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <!-- Barre de progression -->
                <div class="mb-3">
                    {% progress_bar annotation.completion_percentage 100 "mb-3" %}
                </div>
                
                <!-- Alerte pour annotation complète -->
                {% if annotation.is_complete and not annotation.is_validated %}
                <div class="alert alert-info d-flex align-items-center mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <div>
                        <strong>Annotation complète !</strong> 
                        Cette annotation est prête pour validation.
                        {% if can_validate %}
                            <a href="{% url 'documents:validate_annotation' document.pk %}" class="btn btn-sm btn-outline-warning ms-2">
                                <i class="fas fa-check me-1"></i>Valider maintenant
                            </a>
                        {% endif %}
                    </div>
                </div>
                {% elif annotation.completion_percentage < 100 %}
                <div class="alert alert-warning d-flex align-items-center mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <div>
                        <strong>Annotation incomplète</strong> 
                        Complétez tous les champs requis pour pouvoir valider.
                        <a href="{% url 'documents:annotate_document' document.pk %}" class="btn btn-sm btn-outline-primary ms-2">
                            <i class="fas fa-edit me-1"></i>Continuer l'annotation
                        </a>
                    </div>
                </div>
                {% endif %}
                
                {% if annotation.final_annotations %}
                    <div class="row">
                        {% for field in annotation_schema.fields.all %}
                            {% with annotation.final_annotations|lookup:field.name as value %}
                                <div class="col-md-6 mb-3">
                                    <div class="card bg-light">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start mb-1">
                                                <h6 class="card-title mb-1">
                                                    {{ field.label }}
                                                    {% if field.is_required %}
                                                        <span class="text-danger">*</span>
                                                    {% endif %}
                                                </h6>
                                                <span class="badge bg-info field-type-badge">
                                                    <i class="{{ field.field_type|field_type_icon }} me-1"></i>
                                                    {{ field.get_field_type_display }}
                                                </span>
                                            </div>
                                            
                                            {% if field.description %}
                                                <p class="text-muted small mb-2">{{ field.description }}</p>
                                            {% endif %}
                                            
                                            <div class="annotation-value">
                                                {% field_value_display field value %}
                                            </div>
                                            
                                            <!-- Comparaison avec la pré-annotation IA -->
                                            {% if annotation.ai_pre_annotations %}
                                                {% with annotation.ai_pre_annotations|lookup:field.name as ai_value %}
                                                    {% if ai_value and ai_value != value %}
                                                        <div class="mt-2 p-2 bg-warning bg-opacity-10 rounded border-start border-warning border-3">
                                                            <small class="text-muted">
                                                                <i class="fas fa-robot me-1"></i>Suggestion IA : 
                                                                <span class="fw-bold">{{ ai_value|smart_truncate:50 }}</span>
                                                            </small>
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                        <p>Aucune annotation disponible pour ce document.</p>
                    </div>
                {% endif %}
                
                <!-- Métadonnées de l'annotation -->
                <hr>
                <div class="row text-muted small">
                    <div class="col-md-6">
                        <strong>Informations de l'annotation :</strong><br>
                        <i class="fas fa-user me-1"></i>Annoté par : {{ annotation.annotated_by.get_full_name|default:annotation.annotated_by.username }}<br>
                        <i class="fas fa-clock me-1"></i>Dernière modification : {{ annotation.updated_at|date:"d/m/Y H:i" }}<br>
                        <i class="fas fa-calendar me-1"></i>Créé le : {{ annotation.created_at|date:"d/m/Y H:i" }}
                    </div>
                    <div class="col-md-6">
                        <strong>Schéma utilisé :</strong><br>
                        <i class="fas fa-sitemap me-1"></i>{{ annotation.schema.name }}<br>
                        <i class="fas fa-list me-1"></i>{{ annotation.schema.fields.count }} champ(s)<br>
                        {% if annotation.schema.description %}
                            <i class="fas fa-info me-1"></i>{{ annotation.schema.description|smart_truncate:50 }}
                        {% endif %}
                        
                        {% if annotation.confidence_score %}
                            <br><i class="fas fa-star me-1"></i>Score de confiance : 
                            <span class="badge bg-{{ annotation.confidence_score|confidence_color }}">
                                {{ annotation.confidence_score }}/10
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                {% if annotation.validation_notes %}
                    <div class="mt-3">
                        <strong>Notes de validation :</strong>
                        <div class="bg-light p-2 rounded mt-1">{{ annotation.validation_notes }}</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Workflow de traitement -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-route me-2"></i>Workflow de traitement
                </h5>
            </div>
            <div class="card-body">
                <div class="workflow-steps">
                    <div class="step {% if document.status == 'uploaded' or document.status == 'metadata_extracted' %}active{% elif document.status != 'uploaded' %}completed{% endif %}">
                        <div class="step-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="step-content">
                            <h6>1. Téléversement</h6>
                            <p class="mb-0">Document téléversé et métadonnées extraites</p>
                        </div>
                    </div>
                    
                    <div class="step {% if document.status == 'schema_proposed' %}active{% elif document.status in 'schema_validated,pre_annotated,annotated,validated' %}completed{% endif %}">
                        <div class="step-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="step-content">
                            <h6>2. Génération du schéma</h6>
                            <p class="mb-0">L'IA propose un schéma d'annotation</p>
                        </div>
                    </div>
                    
                    <div class="step {% if document.status == 'schema_validated' %}active{% elif document.status in 'pre_annotated,annotated,validated' %}completed{% endif %}">
                        <div class="step-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="step-content">
                            <h6>3. Validation du schéma</h6>
                            <p class="mb-0">Schéma ajusté et validé par l'annotateur</p>
                        </div>
                    </div>
                    
                    <div class="step {% if document.status == 'pre_annotated' or document.status == 'annotated' %}active{% elif document.status == 'validated' %}completed{% endif %}">
                        <div class="step-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="step-content">
                            <h6>4. Annotation</h6>
                            <p class="mb-0">Pré-annotation IA et ajustements manuels</p>
                        </div>
                    </div>
                    
                    <div class="step {% if document.status == 'validated' %}completed{% endif %}">
                        <div class="step-icon">
                            <i class="fas fa-medal"></i>
                        </div>
                        <div class="step-content">
                            <h6>5. Validation finale</h6>
                            <p class="mb-0">Validation par un expert et archivage</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.metadata-item {
    background-color: #f8f9fa;
    padding: 0.75rem;
    border-radius: 0.375rem;
    border-left: 3px solid #0d6efd;
    margin-bottom: 0.5rem;
}

.metadata-key {
    font-weight: 600;
    color: #495057;
    font-size: 0.9rem;
}

.metadata-value {
    color: #6c757d;
    word-break: break-word;
    font-size: 0.9rem;
}

.field-type-badge {
    font-size: 0.7em;
}

.annotation-value {
    background-color: #fff;
    padding: 0.75rem;
    border-radius: 0.375rem;
    border: 1px solid #e9ecef;
    min-height: 3rem;
    display: flex;
    align-items: center;
}

.workflow-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.step {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-radius: 0.5rem;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.step.active {
    border-color: #ffc107;
    background-color: #fff8e1;
}

.step.completed {
    border-color: #198754;
    background-color: #f0fff4;
}

.step-icon {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
}

.step.active .step-icon {
    background-color: #ffc107;
    color: white;
}

.step.completed .step-icon {
    background-color: #198754;
    color: white;
}

.step-content h6 {
    margin-bottom: 0.25rem;
    font-weight: 600;
}

.step-content p {
    color: #6c757d;
    font-size: 0.9rem;
}

/* Responsive */
@media (max-width: 768px) {
    .workflow-steps {
        gap: 0.5rem;
    }
    
    .step {
        padding: 0.75rem;
    }
    
    .step-icon {
        width: 2.5rem;
        height: 2.5rem;
        margin-right: 0.75rem;
    }
    
    .step-content h6 {
        font-size: 0.9rem;
    }
    
    .step-content p {
        font-size: 0.8rem;
    }
}

.user-avatar {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    text-decoration: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Fonction pour régénérer le schéma
function regenerateSchema() {
    if (!confirm('Êtes-vous sûr de vouloir régénérer le schéma ? Cela remplacera le schéma actuel.')) {
        return;
    }
    
    $.ajax({
        url: '{% url "documents:regenerate_schema" document.pk %}',
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Erreur: ' + data.error, 'danger');
            }
        },
        error: function() {
            showToast('Erreur lors de la communication avec le serveur', 'danger');
        }
    });
}

// Fonction pour régénérer les annotations
function regenerateAnnotations() {
    if (!confirm('Êtes-vous sûr de vouloir régénérer les pré-annotations ? Cela remplacera les annotations actuelles.')) {
        return;
    }
    
    $.ajax({
        url: '{% url "documents:regenerate_annotations" document.pk %}',
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Erreur: ' + data.error, 'danger');
            }
        },
        error: function() {
            showToast('Erreur lors de la communication avec le serveur', 'danger');
        }
    });
}

// Fonction pour afficher des toasts
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '11';
    document.body.appendChild(container);
    return container;
}

// Initialisation
$(document).ready(function() {
    // Tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
    
    // Animation des cards au hover
    $('.card').hover(
        function() {
            $(this).addClass('shadow-sm');
        },
        function() {
            $(this).removeClass('shadow-sm');
        }
    );
});
</script>
{% endblock %}