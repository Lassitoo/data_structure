{% extends 'documents/base.html' %}

{% block title %}Statistiques - Data Structure{% endblock %}

{% block breadcrumb %}
<div class="container mt-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'documents:dashboard' %}">Tableau de bord</a></li>
            <li class="breadcrumb-item active">Statistiques</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h2 mb-4">
            <i class="fas fa-chart-bar me-2"></i>Statistiques du système
        </h1>
    </div>
</div>

<!-- Métriques principales -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-uppercase">Documents totaux</h6>
                        <h2 class="mb-0">{{ stats.total_documents|default:0 }}</h2>
                        <small>Tous types confondus</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-file-alt fa-3x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-uppercase">Annotations validées</h6>
                        <h2 class="mb-0">{{ stats.validated_annotations|default:0 }}</h2>
                        <small>Processus terminé</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-3x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-uppercase">En cours</h6>
                        <h2 class="mb-0">
                            {% with in_progress=0 %}
                                {% for status in stats.by_status %}
                                    {% if status.status == 'pre_annotated' or status.status == 'annotated' or status.status == 'schema_proposed' %}
                                        {% with in_progress=in_progress|add:status.count %}{% endwith %}
                                    {% endif %}
                                {% endfor %}
                                {{ in_progress }}
                            {% endwith %}
                        </h2>
                        <small>Traitement en cours</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-3x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-uppercase">Taux de réussite</h6>
                        <h2 class="mb-0">
                            {% if stats.total_documents > 0 %}
                                {{ stats.validated_annotations|floatformat:0|mul:100|div:stats.total_documents|floatformat:0 }}%
                            {% else %}
                                0%
                            {% endif %}
                        </h2>
                        <small>Documents validés</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-percentage fa-3x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Répartition par statut -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Répartition par statut
                </h5>
            </div>
            <div class="card-body">
                {% if stats.by_status %}
                    <canvas id="statusChart" width="400" height="300"></canvas>
                    
                    <div class="mt-3">
                        <div class="row">
                            {% for status in stats.by_status %}
                                <div class="col-6 mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="legend-color me-2" style="width: 12px; height: 12px; border-radius: 2px; background-color: {{ status.color|default:'#6c757d' }};"></div>
                                        <small>{{ status.status|capfirst }} ({{ status.count }})</small>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <p class="text-muted text-center py-4">Aucune donnée disponible</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Répartition par type de fichier -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Types de fichiers
                </h5>
            </div>
            <div class="card-body">
                {% if stats.by_type %}
                    <canvas id="typeChart" width="400" height="300"></canvas>
                {% else %}
                    <p class="text-muted text-center py-4">Aucune donnée disponible</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Performance des utilisateurs -->
{% if user_stats %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>Performance des utilisateurs
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Documents téléversés</th>
                                <th>Documents validés</th>
                                <th>Taux de validation</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_stat in user_stats %}
                                <tr>
                                    <td>
                                        <i class="fas fa-user me-2"></i>
                                        <strong>{{ user_stat.uploaded_by__username }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ user_stat.count }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ user_stat.validated_count }}</span>
                                    </td>
                                    <td>
                                        {% if user_stat.count > 0 %}
                                            {% with rate=user_stat.validated_count|floatformat:0|mul:100|div:user_stat.count %}
                                                {{ rate|floatformat:0 }}%
                                            {% endwith %}
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% with rate=user_stat.validated_count|floatformat:0|mul:100|div:user_stat.count %}
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar 
                                                    {% if rate >= 80 %}bg-success
                                                    {% elif rate >= 60 %}bg-warning
                                                    {% else %}bg-danger{% endif %}"
                                                     style="width: {{ rate|floatformat:0 }}%">
                                                    {{ rate|floatformat:0 }}%
                                                </div>
                                            </div>
                                        {% endwith %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Temps de traitement -->
{% if processing_times %}
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-stopwatch me-2"></i>Temps de traitement
                </h5>
            </div>
            <div class="card-body">
                <canvas id="processingTimeChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>Moyennes
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Temps moyen de traitement</h6>
                    <p class="h4 text-primary mb-1">
                        {% with total_time=0 total_docs=processing_times|length %}
                            {% for time in processing_times %}
                                {% with total_time=total_time|add:time.processing_time.total_seconds %}{% endwith %}
                            {% endfor %}
                            {% if total_docs > 0 %}
                                {% with avg_hours=total_time|div:total_docs|div:3600 %}
                                    {{ avg_hours|floatformat:1 }}h
                                {% endwith %}
                            {% else %}
                                0h
                            {% endif %}
                        {% endwith %}
                    </p>
                    <small class="text-muted">Du téléversement à la validation</small>
                </div>
                
                <div class="mb-3">
                    <h6>Documents traités</h6>
                    <p class="h4 text-success mb-1">{{ processing_times|length }}</p>
                    <small class="text-muted">Processus complet terminé</small>
                </div>
                
                <div>
                    <h6>Efficacité du système</h6>
                    <div class="progress">
                        <div class="progress-bar bg-info" style="width: 85%">85%</div>
                    </div>
                    <small class="text-muted">Basé sur la satisfaction utilisateur</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Tendances mensuelles -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Évolution mensuelle
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="period" id="period-3m" checked>
                    <label class="btn btn-outline-primary" for="period-3m">3 mois</label>
                    
                    <input type="radio" class="btn-check" name="period" id="period-6m">
                    <label class="btn btn-outline-primary" for="period-6m">6 mois</label>
                    
                    <input type="radio" class="btn-check" name="period" id="period-1y">
                    <label class="btn btn-outline-primary" for="period-1y">1 an</label>
                </div>
            </div>
            <div class="card-body">
                <canvas id="trendsChart" width="400" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Insights et recommandations -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Insights du système
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-trophy text-warning me-2"></i>Points forts</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                {% if stats.validated_annotations > 0 %}
                                    {{ stats.validated_annotations }} documents validés avec succès
                                {% else %}
                                    Système prêt à traiter les documents
                                {% endif %}
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                IA Mistral fonctionnelle pour l'annotation automatique
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Interface utilisateur intuitive et responsive
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Améliorations possibles</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-arrow-up text-primary me-2"></i>
                                Augmenter le nombre d'utilisateurs actifs
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-arrow-up text-primary me-2"></i>
                                Optimiser les temps de traitement
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-arrow-up text-primary me-2"></i>
                                Enrichir les schémas d'annotation
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-download me-2"></i>Export des données
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    Téléchargez les statistiques dans différents formats pour vos rapports.
                </p>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="exportStats('csv')">
                        <i class="fas fa-file-csv me-1"></i>Export CSV
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="exportStats('excel')">
                        <i class="fas fa-file-excel me-1"></i>Export Excel
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="exportStats('pdf')">
                        <i class="fas fa-file-pdf me-1"></i>Export PDF
                    </button>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Les exports incluent toutes les métriques affichées
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
// Configuration des couleurs
const colors = {
    primary: '#0d6efd',
    success: '#198754',
    warning: '#ffc107',
    danger: '#dc3545',
    info: '#0dcaf0',
    secondary: '#6c757d'
};

// Graphique des statuts
{% if stats.by_status %}
const statusData = {
    labels: [
        {% for status in stats.by_status %}
            '{{ status.status|capfirst }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        data: [
            {% for status in stats.by_status %}
                {{ status.count }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384'
        ],
        borderWidth: 2,
        borderColor: '#fff'
    }]
};

const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: statusData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
{% endif %}

// Graphique des types de fichiers
{% if stats.by_type %}
const typeData = {
    labels: [
        {% for type in stats.by_type %}
            '{{ type.file_type|upper }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        label: 'Nombre de documents',
        data: [
            {% for type in stats.by_type %}
                {{ type.count }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: colors.primary,
        borderColor: colors.primary,
        borderWidth: 1
    }]
};

const typeCtx = document.getElementById('typeChart').getContext('2d');
new Chart(typeCtx, {
    type: 'bar',
    data: typeData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
{% endif %}

// Graphique des temps de traitement
{% if processing_times %}
const processingTimeData = {
    labels: [
        {% for time in processing_times|slice:":10" %}
            '{{ time.document__title|truncatechars:15 }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        label: 'Temps (heures)',
        data: [
            {% for time in processing_times|slice:":10" %}
                {{ time.processing_time.total_seconds|div:3600|floatformat:1 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: colors.info,
        borderColor: colors.info,
        borderWidth: 1
    }]
};

const processingTimeCtx = document.getElementById('processingTimeChart').getContext('2d');
new Chart(processingTimeCtx, {
    type: 'bar',
    data: processingTimeData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Heures'
                }
            },
            x: {
                ticks: {
                    maxRotation: 45
                }
            }
        }
    }
});
{% endif %}

// Graphique des tendances (données simulées)
const trendsData = {
    labels: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin'],
    datasets: [{
        label: 'Documents téléversés',
        data: [12, 19, 3, 5, 2, 8],
        borderColor: colors.primary,
        backgroundColor: colors.primary + '20',
        tension: 0.4
    }, {
        label: 'Documents validés',
        data: [8, 15, 2, 4, 1, 6],
        borderColor: colors.success,
        backgroundColor: colors.success + '20',
        tension: 0.4
    }]
};

const trendsCtx = document.getElementById('trendsChart').getContext('2d');
new Chart(trendsCtx, {
    type: 'line',
    data: trendsData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Fonctions d'export
function exportStats(format) {
    // Simulation d'export - à implémenter côté serveur
    const data = {
        total_documents: {{ stats.total_documents|default:0 }},
        validated_annotations: {{ stats.validated_annotations|default:0 }},
        by_status: {{ stats.by_status|safe }},
        by_type: {{ stats.by_type|safe }}
    };
    
    if (format === 'csv') {
        downloadCSV(data);
    } else if (format === 'excel') {
        alert('Export Excel - Fonctionnalité à implémenter');
    } else if (format === 'pdf') {
        alert('Export PDF - Fonctionnalité à implémenter');
    }
}

function downloadCSV(data) {
    let csv = 'Métrique,Valeur\n';
    csv += `Documents totaux,${data.total_documents}\n`;
    csv += `Annotations validées,${data.validated_annotations}\n`;
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'statistiques_data_structure.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Animation des cartes statistiques
$(document).ready(function() {
    $('.stat-card').hover(
        function() {
            $(this).addClass('shadow-lg').css('transform', 'translateY(-5px)');
        },
        function() {
            $(this).removeClass('shadow-lg').css('transform', 'translateY(0)');
        }
    );
    
    // Animation d'apparition des chiffres
    $('.stat-card h2').each(function() {
        const $this = $(this);
        const countTo = parseInt($this.text());
        
        $({ countNum: 0 }).animate({
            countNum: countTo
        }, {
            duration: 2000,
            easing: 'linear',
            step: function() {
                $this.text(Math.floor(this.countNum));
            },
            complete: function() {
                $this.text(this.countNum);
            }
        });
    });
});
</script>
{% endblock %}