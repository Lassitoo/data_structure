{# template/documents/annotation_editor.html #}

{% extends 'documents/base.html' %}
{% load document_filters %}

{% block title %}Annoter - {{ document.title }} - Data Structure{% endblock %}

{% block breadcrumb %}
<div class="container mt-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'documents:dashboard' %}">Tableau de bord</a></li>
            <li class="breadcrumb-item"><a href="{% url 'documents:document_list' %}">Documents</a></li>
            <li class="breadcrumb-item"><a href="{% url 'documents:document_detail' document.pk %}">{{ document.title|truncatechars:30 }}</a></li>
            <li class="breadcrumb-item active">Annotation</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h1 class="h2">
                    <i class="fas fa-edit me-2"></i>Annotation du document
                </h1>
                <p class="text-muted">{{ document.title }}</p>
            </div>
            <div class="text-end">
                <div class="mb-2">
                    <span class="badge bg-primary fs-6">{{ completion_percentage|floatformat:0 }}% complété</span>
                </div>
                <div class="progress" style="width: 200px;">
                    <div class="progress-bar" style="width: {{ completion_percentage }}%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Formulaire d'annotation -->
    <div class="col-lg-8">
        <form method="post" id="annotationForm">
            {% csrf_token %}
            
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tags me-2"></i>Champs d'annotation
                    </h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="loadPreAnnotations()">
                            <i class="fas fa-robot me-1"></i>Charger pré-annotations IA
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllFields()">
                            <i class="fas fa-eraser me-1"></i>Vider tout
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if form %}
                        <div class="row">
                            {% for field in form %}
                                <div class="col-md-12 mb-4">
                                    <div class="card border-light">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <label for="{{ field.id_for_label }}" class="form-label fw-bold">
                                                    {{ field.label }}
                                                    {% if field.field.required %}
                                                        <span class="text-danger">*</span>
                                                    {% endif %}
                                                </label>
                                                <span class="badge bg-info">{{ field.field|stringformat:"s"|slice:":20" }}...</span>
                                            </div>
                                            
                                            {% if field.help_text %}
                                                <p class="text-muted small mb-2">{{ field.help_text }}</p>
                                            {% endif %}
                                            
                                            <div class="field-container">
                                                {{ field }}
                                            </div>
                                            
                                            {% if field.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in field.errors %}
                                                        <small>{{ error }}</small>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Suggestions IA pour ce champ -->
                                            {% if annotation.ai_pre_annotations %}
                                                {% with annotation.ai_pre_annotations|lookup:field.name as ai_value %}
                                                    {% if ai_value %}
                                                        <div class="mt-2">
                                                            <small class="text-muted">
                                                                <i class="fas fa-robot me-1"></i>Suggestion IA :
                                                                <span class="badge bg-light text-dark suggestion-value" 
                                                                      data-field="{{ field.name }}" 
                                                                      data-value="{{ ai_value }}"
                                                                      style="cursor: pointer;">
                                                                    {{ ai_value|truncatechars:50 }}
                                                                    <i class="fas fa-plus ms-1"></i>
                                                                </span>
                                                            </small>
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                            <p>Aucun champ d'annotation disponible. Veuillez d'abord valider le schéma.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Boutons d'action -->
            <div class="d-flex justify-content-between mb-4">
                <a href="{% url 'documents:document_detail' document.pk %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Retour
                </a>
                <div>
                    <button type="submit" name="save_draft" class="btn btn-outline-primary me-2">
                        <i class="fas fa-save me-1"></i>Sauvegarder brouillon
                    </button>
                    <button type="submit" name="save_and_continue" class="btn btn-primary me-2">
                        <i class="fas fa-check me-1"></i>Sauvegarder et continuer
                    </button>
                    {% if completion_percentage >= 100 or annotation.is_complete %}
                    <button type="submit" name="save_and_validate" class="btn btn-success">
                        <i class="fas fa-check-double me-1"></i>Sauvegarder et Valider
                    </button>
                    {% else %}
                    <button type="submit" name="save_and_validate" class="btn btn-outline-success" 
                            title="Complétez tous les champs requis pour valider">
                        <i class="fas fa-check-double me-1"></i>Sauvegarder et Valider
                    </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
    
    <!-- Panneau d'aide et aperçu du document -->
    <div class="col-lg-4">
        <!-- Aperçu du document -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>Aperçu du document
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Fichier :</strong> {{ document.filename }}<br>
                    <strong>Type :</strong> {{ document.get_file_type_display }}<br>
                    <strong>Taille :</strong> {{ document.file_size|filesizeformat }}
                </div>
                
                {% if document.metadata.text_preview %}
                    <div class="mt-3">
                        <h6>Contenu :</h6>
                        <div class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                            <pre class="mb-0 small" style="white-space: pre-wrap;">{{ document.metadata.text_preview|truncatechars:800 }}</pre>
                        </div>
                    </div>
                {% endif %}
                
                <div class="mt-3">
                    <a href="{{ document.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt me-1"></i>Ouvrir le fichier
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Schéma d'annotation -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sitemap me-2"></i>Schéma d'annotation
                </h5>
            </div>
            <div class="card-body">
                <h6>{{ schema.name }}</h6>
                <p class="text-muted small">{{ schema.description }}</p>
                
                <div class="mt-3">
                    <h6 class="small">Champs obligatoires :</h6>
                    <ul class="small">
                        {% for field in schema.fields.all %}
                            {% if field.is_required %}
                                <li>{{ field.label }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Conseils d'annotation -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Conseils d'annotation
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-robot me-1"></i>Pré-annotations IA</h6>
                    <p class="small mb-0">L'IA a généré des suggestions pour vous aider. Cliquez sur les badges pour les utiliser comme point de départ.</p>
                </div>
                
                <h6>Bonnes pratiques :</h6>
                <ul class="small">
                    <li>Lisez attentivement le document</li>
                    <li>Soyez précis et cohérent</li>
                    <li>Utilisez les suggestions IA comme guide</li>
                    <li>Vérifiez les champs obligatoires</li>
                    <li>Sauvegardez régulièrement</li>
                </ul>
                
                <div class="mt-3">
                    <h6 class="small">Raccourcis clavier :</h6>
                    <ul class="small text-muted">
                        <li><kbd>Ctrl+S</kbd> : Sauvegarder</li>
                        <li><kbd>Tab</kbd> : Champ suivant</li>
                        <li><kbd>Shift+Tab</kbd> : Champ précédent</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Historique récent -->
        {% if annotation.history.all %}
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Modifications récentes
                </h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% for history in annotation.history.all|slice:":5" %}
                        <div class="timeline-item mb-2">
                            <small class="text-muted">
                                {{ history.created_at|date:"d/m H:i" }} - 
                                {{ history.get_action_type_display }}
                                {% if history.field_name %}
                                    ({{ history.field_name }})
                                {% endif %}
                            </small>
                        </div>
                    {% endfor %}
                </div>
                <a href="{% url 'documents:annotation_history' document.pk %}" class="btn btn-sm btn-outline-secondary">
                    Voir tout l'historique
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de confirmation pour vider les champs -->
<div class="modal fade" id="clearConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir vider tous les champs ? Cette action ne peut pas être annulée.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" onclick="confirmClearAll()">Vider tout</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.field-container .form-control,
.field-container .form-select {
    transition: border-color 0.3s ease;
}

.field-container .form-control:focus,
.field-container .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.suggestion-value:hover {
    background-color: #e9ecef !important;
    color: #495057 !important;
}

.timeline-item {
    border-left: 2px solid #dee2e6;
    padding-left: 10px;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.progress {
    height: 8px;
}

.required-field {
    border-left: 4px solid #dc3545;
}

.completed-field {
    border-left: 4px solid #198754;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let aiPreAnnotations = {{ annotation.ai_pre_annotations|safe }};
let hasUnsavedChanges = false;

$(document).ready(function() {
    // Marquer les champs comme modifiés
    $('input, textarea, select').on('change input', function() {
        hasUnsavedChanges = true;
        updateFieldStatus(this);
    });
    
    // Gestion des suggestions IA
    $('.suggestion-value').on('click', function() {
        const fieldName = $(this).data('field');
        const value = $(this).data('value');
        applySuggestion(fieldName, value);
    });
    
    // Raccourcis clavier
    $(document).on('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            $('#annotationForm').submit();
        }
    });
    
    // Auto-sauvegarde toutes les 2 minutes
    setInterval(autoSave, 120000);
    
    // Avertissement avant de quitter la page
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = 'Vous avez des modifications non sauvegardées. Êtes-vous sûr de vouloir quitter ?';
        }
    });
    
    // Marquer la soumission comme sauvegardée
    $('#annotationForm').on('submit', function() {
        hasUnsavedChanges = false;
    });
    
    // Mise à jour initiale du statut des champs
    updateAllFieldsStatus();
});

function applySuggestion(fieldName, value) {
    const field = $(`[name="${fieldName}"]`);
    
    if (field.length === 0) return;
    
    // Gestion selon le type de champ
    if (field.is('input[type="checkbox"]')) {
        field.prop('checked', value === true || value === 'true');
    } else if (field.is('input[type="radio"]')) {
        $(`input[name="${fieldName}"][value="${value}"]`).prop('checked', true);
    } else if (field.is('select[multiple]')) {
        if (Array.isArray(value)) {
            field.val(value);
        } else {
            field.val([value]);
        }
    } else {
        field.val(value);
    }
    
    // Déclencher l'événement change
    field.trigger('change');
    
    // Animation visuelle
    field.addClass('border-success');
    setTimeout(() => {
        field.removeClass('border-success');
    }, 1000);
    
    showToast(`Suggestion appliquée pour "${fieldName}"`, 'success');
}

function loadPreAnnotations() {
    if (!aiPreAnnotations || Object.keys(aiPreAnnotations).length === 0) {
        showToast('Aucune pré-annotation disponible', 'warning');
        return;
    }
    
    if (!confirm('Cela remplacera les valeurs actuelles par les suggestions de l\'IA. Continuer ?')) {
        return;
    }
    
    let appliedCount = 0;
    
    Object.keys(aiPreAnnotations).forEach(fieldName => {
        const value = aiPreAnnotations[fieldName];
        if (value !== null && value !== '') {
            applySuggestion(fieldName, value);
            appliedCount++;
        }
    });
    
    showToast(`${appliedCount} suggestions appliquées`, 'success');
}

function clearAllFields() {
    const modal = new bootstrap.Modal(document.getElementById('clearConfirmModal'));
    modal.show();
}

function confirmClearAll() {
    $('input, textarea, select').each(function() {
        if ($(this).is('input[type="checkbox"], input[type="radio"]')) {
            $(this).prop('checked', false);
        } else {
            $(this).val('');
        }
    });
    
    hasUnsavedChanges = true;
    updateAllFieldsStatus();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('clearConfirmModal'));
    modal.hide();
    
    showToast('Tous les champs ont été vidés', 'info');
}

function updateFieldStatus(field) {
    const $field = $(field);
    const $container = $field.closest('.card');
    
    // Vérifier si le champ est rempli
    const isEmpty = !$field.val() || ($field.is('input[type="checkbox"], input[type="radio"]') && !$field.is(':checked'));
    
    if (isEmpty) {
        $container.removeClass('completed-field');
        if ($field.prop('required')) {
            $container.addClass('required-field');
        }
    } else {
        $container.removeClass('required-field').addClass('completed-field');
    }
}

function updateAllFieldsStatus() {
    $('input, textarea, select').each(function() {
        updateFieldStatus(this);
    });
}

function autoSave() {
    if (!hasUnsavedChanges) return;
    
    const formData = new FormData(document.getElementById('annotationForm'));
    formData.append('auto_save', 'true');
    
    $.ajax({
        url: window.location.href,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
            hasUnsavedChanges = false;
            showToast('Sauvegarde automatique effectuée', 'info');
        },
        error: function() {
            showToast('Erreur lors de la sauvegarde automatique', 'danger');
        }
    });
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '11';
    document.body.appendChild(container);
    return container;
}

// Validation en temps réel
function validateForm() {
    let isValid = true;
    const requiredFields = $('input[required], textarea[required], select[required]');
    
    requiredFields.each(function() {
        const $field = $(this);
        const isEmpty = !$field.val() || ($field.is('input[type="checkbox"], input[type="radio"]') && !$field.is(':checked'));
        
        if (isEmpty) {
            isValid = false;
            $field.addClass('is-invalid');
        } else {
            $field.removeClass('is-invalid');
        }
    });
    
    return isValid;
}

// Gestion de la soumission du formulaire
$('#annotationForm').on('submit', function(e) {
    if (!validateForm()) {
        e.preventDefault();
        showToast('Veuillez remplir tous les champs obligatoires', 'danger');
        return false;
    }
    
    const submitBtn = $(this).find('button[type="submit"]:focus');
    if (submitBtn.length) {
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Sauvegarde...');
    }
});
</script>
{% endblock %}